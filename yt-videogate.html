<head>
  <title>yt-videogate</title>
</head>

<body>
	<div class="container">
		

	</div>
</body>

<template name="home">
  		{{> youtubeURLForm}}
  		<div id="ytplayer"></div>
  		{{> youtubeurls}}
</template>

<template name="hello">
  <button>Click Me</button>
  <p>You've pressed the button {{counter}} times.</p>
</template>

<template name="youtubeURLForm">
	<form role="form">
	  <div class="form-group">
	    <label for="youtubeURL">YouTube URL</label>
	    <input type="text" class="form-control" id="youtubeURL" name="youtubeURL" placeholder="Enter YouTube URL">
	  </div>
	  <div class="form-group">
	    <label for="vidgatemsg">Video Gating Message</label>
	    <input type="text" class="form-control" id="vidgatemsg" name="vidgatemsg" placeholder="Message for your Video Gate">
	  </div>
	  <div class="form-group" id="vidgatefields">
	    <label for="vidgatefields">Fields to collect</label>
	    <label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox1" value="fname"> First Name
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox2" value="lname"> Last Name
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox3" value="email"> Email
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox4" value="company"> Company
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox5" value="phone"> Phone
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox6" value="address"> Address
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox7" value="city"> City
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox8" value="state"> State
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox9" value="zip"> Zip Code
		</label>
	  </div>
	  <button type="submit" class="btn btn-default submit">Submit</button>
	</form>
</template>

<template name="youtubeurl">
	<span id="pref-{{_id}}"><span id="ytid">{{youtubeId}}</span>, <span id="stopAt">{{stopAt}}</span> {{date}}</span>
	<span id="vd-gt-msg">{{msg}}</span>
</template>

<template name="leads">
	<div style="display:none">
		<span id="pref-{{_id}}"><span id="ytid">{{youtubeId}}</span>, <span id="stopAt">{{stopAt}}</span> {{date}}</span>
		<span id="vd-gt-msg">{{msg}}</span>
		<ul>
		{{#each lead}}
			<li>{{email}}</li>
		{{/each}}
		</ul>
	</div>
</template>

<template name="youtubeurls">
    {{#each items}}
        {{> youtubeurl}}
        <div class="slider"></div><div id="field"></div>
		<button id="videogate-time-save" type="submit" class="btn btn-default save" style="display:none">Save</button>
		<button class="btn btn-default">Get Widget Code</button><a href="/widget/{{_id}}" class="btn btn-primary">Preview Widget</a>
		<textarea id="widget-code">
			<div id="ytapi-wrap" style="height: 0; padding-bottom: 56.25%; position: relative;">
				<iframe src="http://localhost:3000/widget/{{_id}}" width="" height="" style="height: 100%;left: 0;position: absolute;top: 0;width: 100%;"></iframe>
			</div>
		</textarea>	
     {{/each}}
</template>

<template name="widget">
        {{> leads}}

        <div id="ytapi-wrap">
        	<form id="vg-widget-form" style="display:none" class="form-horizontal">
        		<h4>{{msg}}</h4>
        		{{#if incFname}}
        		<div class="form-group">
		    		<label for="ytvg_fname">First Name</label>
	        		<input class="form-control" type="text" value="" name="ytvg_fname" id="ytvg_fname"/>
        		</div>
        		{{/if}}
        		{{#if incLname}}
        		<div class="form-group">
		    		<label for="ytvg_lname">Last Name</label>
	        		<input class="form-control" type="text" value="" name="ytvg_lname" id="ytvg_lname"/>
        		</div>
        		{{/if}}
        		{{#if incCompany}}
        		<div class="form-group">
		    		<label for="ytvg_company">Company</label>
	        		<input class="form-control" type="text" value="" name="ytvg_company" id="ytvg_company"/>
        		</div>
        		{{/if}}
        		{{#if incAddress}}
        		<div class="form-group">
		    		<label for="ytvg_address">Address</label>
	        		<input class="form-control" type="text" value="" name="ytvg_address" id="ytvg_address"/>
        		</div>
        		{{/if}}
        		<div class="form-inline">
        		<div class="form-group">
		    		{{#if incCity}}<label for="ytvg_address">City</label>
	        		<input class="form-control" type="text" value="" name="ytvg_city" id="ytvg_city"/>{{/if}}
	        		{{#if incState}}<label for="ytvg_state">State</label>
	        		<input class="form-control" type="text" value="" name="ytvg_state" id="ytvg_state" min="2" max="2" />{{/if}}
	        		{{#if incZip}}<label for="ytvg_zip">Zip Code</label>
	        		<input class="form-control" type="text" value="" name="ytvg_zip" id="ytvg_zip"/>{{/if}}
        		</div>
        		</div>
        		{{#if incEmail}}
        		<div class="form-group">
		    		<label for="ytvg_email">Email</label>
	        		<input class="form-control" type="email" value="" name="ytvg_email" id="ytvg_email"/>
        		</div>
        		{{/if}}
        		{{#if incPhone}}
        		<div class="form-group">
		    		<label for="ytvg_phone">Phone</label>
	        		<input class="form-control" type="phone" value="" name="ytvg_phone" id="ytvg_phone"/>
        		</div>
        		{{/if}}
        		<button class="btn btn-default" type="submit" id="submitform">Submit</button>
        	</form>
        </div>
        <a class="btn btn-primary" href="/widget/{{_id}}/edit">Edit Widget</a><a class="btn btn-default" href="/">New Widget</a>
</template>


<template name="edit_widget">
	<form role="form">
		<input type="hidden" value="{{_id}}" id="vidID" />
	  <div class="form-group">
	    <label for="youtubeURL">YouTube URL</label>
	    <input type="text" class="form-control" id="youtubeURL" name="youtubeURL" value="{{youtubeId}}" disabled>
	  </div>
	  <div class="form-group">
	    <label for="vidgatemsg">Video Gating Message</label>
	    <input type="text" class="form-control" id="vidgatemsg" name="vidgatemsg" value="{{msg}}">
	  </div>
	  <div class="form-group">
	    <label for="vidgatemsg">Video Gate Time</label>
	    <input type="text" class="form-control" id="stopAt" name="stopAt" value="{{stopAt}}">
	  </div>
	  <div class="form-group" id="vidgatefields">
	    <label for="vidgatefields">Fields to collect</label>
	    <label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox1" value="fname"> First Name
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox2" value="lname"> Last Name
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox3" value="email"> Email
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox4" value="company"> Company
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox5" value="phone"> Phone
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox6" value="address"> Address
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox7" value="city"> City
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox8" value="state"> State
		</label>
		<label class="checkbox-inline">
		  <input type="checkbox" id="inlineCheckbox9" value="zip"> Zip Code
		</label>
	  </div>
	  <button type="submit" class="btn btn-default submit" id="submitform">Submit</button>
	</form>
</template>

<template name="ytapi">
	<div id="ytplayer"></div>
	<script>
			var ytid = $('#ytid').text();
			var ytstopAt = $('#stopAt').text();
			var player = undefined;

			var tag = document.createElement('script');
		    tag.src = "//www.youtube.com/iframe_api";
		    tag.id = "iframe_api_script";
		    var firstScriptTag = document.getElementsByTagName('script')[0];
		    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		     window.onYouTubePlayerAPIReady = function() {
		        player = new YT.Player('ytplayer', {
		          videoId: ytid,
		          playerVars: {
		          	'modestbranding': 1
		          },
		          events: {
		            'onReady': onPlayerReady,
		            'onStateChange': onPlayerStateChange
		          }, 
		          playerVars: {enablejsapi: true}
		        });
		      }

		      function onPlayerReady(event) {
		        var len = player.getDuration();
		      }
		      var done = false;
	          //TODO: also show form if they haven't filled it out, even if after the stop time.
	          //set a cookie and if cookie is not set, then force player back to stopAt time and pause.
	          //when form is submitted, resume video and remove form.
	          //player.loadVideoById(videoId:String, startSeconds:Number, suggestedQuality:String):Void
	          function onPlayerStateChange(event) {
	            	var stop = ytstopAt * 1000;
	              	var currentTime = player.getCurrentTime();
	              	var cookie = Cookie.get('yt-vidgate');
	              	console.log(cookie);

	              	if (cookie != 'yt-vidgate-unlocked') {
	              		if ( currentTime > ytstopAt ) {
		              		stopVideoSeek(); //only true if form has not been filled out;
		              	}
		            
			            if (event.data == YT.PlayerState.PLAYING && !done) {
			              setTimeout(stopVideo, stop);
			              done = true;
			            }
	              	}
		         
	          	}

	          function stopVideoSeek() {
	          	player.pauseVideo();
	            player.seekTo(ytstopAt, false);

	          }

	          function stopVideo() {
	            player.pauseVideo();
            	$('#vg-widget-form').show();
	          }

	</script>
</template>



